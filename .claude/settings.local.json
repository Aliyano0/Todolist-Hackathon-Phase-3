{
  "permissions": {
    "allow": [
      "Bash(.specify/scripts/bash/setup-plan.sh:*)",
      "Bash(uv run pytest:*)",
      "Bash(.specify/scripts/bash/check-prerequisites.sh --json)",
      "Bash(.specify/scripts/bash/check-prerequisites.sh:*)",
      "Bash(npm run build)",
      "Bash(git fetch --all --prune)",
      "Bash(source:*)",
      "Bash(python:*)",
      "Bash(backend/tests/integration/test_chat_update_task.py << 'EOF'\n\"\"\"\nIntegration test for chat endpoint task updates\n\nTests the full flow of natural language task updates through the chat endpoint.\nFollowing TDD: These tests should FAIL before implementation.\n\"\"\"\n\nimport pytest\nimport uuid\nfrom httpx import AsyncClient\nfrom datetime import datetime, timedelta\nfrom jose import jwt\nimport os\n\nfrom main import app\nfrom database.session import get_session\nfrom models.user import User\nfrom models.todo import TodoTask\nfrom sqlmodel import select\n\n\n@pytest.fixture\nasync def verified_user_with_tasks\\(session\\):\n    \"\"\"Create a verified user with sample tasks\"\"\"\n    user = User\\(\n        email=\"test@example.com\",\n        password_hash=\"hashed_password\",\n        email_verified=True,\n        verification_token=None\n    \\)\n    session.add\\(user\\)\n    await session.commit\\(\\)\n    await session.refresh\\(user\\)\n\n    # Add sample tasks\n    tasks = [\n        TodoTask\\(\n            user_id=user.id,\n            title=\"Buy groceries\",\n            description=\"Milk and eggs\",\n            completed=False\n        \\),\n        TodoTask\\(\n            user_id=user.id,\n            title=\"Finish report\",\n            description=\"Q4 report\",\n            completed=False\n        \\)\n    ]\n    \n    for task in tasks:\n        session.add\\(task\\)\n    \n    await session.commit\\(\\)\n    \n    return user\n\n\n@pytest.fixture\ndef auth_token\\(verified_user_with_tasks\\):\n    \"\"\"Create a valid JWT token for the verified user\"\"\"\n    secret = os.getenv\\(\"BETTER_AUTH_SECRET\", \"test-secret-key-for-testing-only\"\\)\n    payload = {\n        \"sub\": str\\(verified_user_with_tasks.id\\),\n        \"email\": verified_user_with_tasks.email,\n        \"email_verified\": True,\n        \"exp\": datetime.utcnow\\(\\) + timedelta\\(hours=1\\)\n    }\n    token = jwt.encode\\(payload, secret, algorithm=\"HS256\"\\)\n    return token\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_title\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test updating task title through natural language\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Change task 1 title to 'Buy groceries and snacks'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    data = response.json\\(\\)\n\n    # Verify response mentions update\n    message_lower = data[\"message\"].lower\\(\\)\n    assert any\\(keyword in message_lower for keyword in [\"updated\", \"changed\", \"renamed\"]\\)\n    \n    # Verify task is updated in database\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id,\n                TodoTask.title.contains\\(\"snacks\"\\)\n            \\)\n        \\)\n        task = result.scalar_one_or_none\\(\\)\n        assert task is not None\n        assert \"snacks\" in task.title.lower\\(\\)\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_description\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test updating task description through natural language\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Update task 1 description to 'Milk, eggs, bread, and butter'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    \n    # Verify in database\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id,\n                TodoTask.title == \"Buy groceries\"\n            \\)\n        \\)\n        task = result.scalar_one_or_none\\(\\)\n        assert task is not None\n        assert \"butter\" in task.description.lower\\(\\)\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_ambiguous_request\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test that agent asks for clarification on ambiguous update requests\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Update task 1\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    data = response.json\\(\\)\n\n    # Agent should ask what to update\n    message_lower = data[\"message\"].lower\\(\\)\n    assert any\\(keyword in message_lower for keyword in [\"what\", \"which\", \"title\", \"description\", \"change\"]\\)\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_not_found\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test updating a non-existent task\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Update task 999 title to 'New title'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    data = response.json\\(\\)\n\n    # Agent should indicate task not found\n    message_lower = data[\"message\"].lower\\(\\)\n    assert any\\(keyword in message_lower for keyword in [\"not found\", \"doesn't exist\", \"can't find\"]\\)\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_variations\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test different natural language variations for updating tasks\"\"\"\n    variations = [\n        \"Change task 1 title to 'New title'\",\n        \"Rename task 1 to 'New title'\",\n        \"Update task 1 name to 'New title'\",\n        \"Modify task 1 title to 'New title'\"\n    ]\n    \n    for message in variations:\n        async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n            response = await client.post\\(\n                f\"/api/{verified_user_with_tasks.id}/chat\",\n                json={\"message\": message},\n                headers={\"Authorization\": f\"Bearer {auth_token}\"}\n            \\)\n\n        assert response.status_code == 200\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_with_confirmation\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test that agent provides confirmation with old and new values\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Change task 1 title to 'Buy groceries and snacks'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    data = response.json\\(\\)\n\n    # Agent should mention the update\n    message_lower = data[\"message\"].lower\\(\\)\n    assert \"updated\" in message_lower or \"changed\" in message_lower\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_by_name\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test updating task by name instead of position\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Change 'Buy groceries' to 'Buy groceries and snacks'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    \n    # Verify in database\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id,\n                TodoTask.title.contains\\(\"snacks\"\\)\n            \\)\n        \\)\n        task = result.scalar_one_or_none\\(\\)\n        assert task is not None\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_user_isolation\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test that users cannot update other users' tasks\"\"\"\n    # Create another user with a task\n    async with get_session\\(\\) as session:\n        other_user = User\\(\n            email=\"other@example.com\",\n            password_hash=\"hashed\",\n            email_verified=True\n        \\)\n        session.add\\(other_user\\)\n        await session.commit\\(\\)\n        await session.refresh\\(other_user\\)\n        \n        other_task = TodoTask\\(\n            user_id=other_user.id,\n            title=\"Other user's task\",\n            completed=False\n        \\)\n        session.add\\(other_task\\)\n        await session.commit\\(\\)\n        await session.refresh\\(other_task\\)\n        other_task_id = other_task.id\n        original_title = other_task.title\n    \n    # Try to update other user's task\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": f\"Update task {other_task_id} title to 'Hacked'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    \n    # Task should NOT be updated \\(user isolation\\)\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(TodoTask.id == other_task_id\\)\n        \\)\n        task = result.scalar_one_or_none\\(\\)\n        assert task.title == original_title  # Title unchanged\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_multilingual_roman_urdu\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test updating task in Roman Urdu\"\"\"\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Task 1 ka title change karo 'Groceries khareedna'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    \n    # Verify task is updated\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id\n            \\)\n        \\)\n        tasks = result.scalars\\(\\).all\\(\\)\n        # At least one task should have been updated\n        assert len\\(tasks\\) > 0\n\n\n@pytest.mark.asyncio\nasync def test_chat_update_task_preserves_other_fields\\(verified_user_with_tasks, auth_token\\):\n    \"\"\"Test that updating title doesn't affect other fields\"\"\"\n    # Get original task state\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id,\n                TodoTask.title == \"Buy groceries\"\n            \\)\n        \\)\n        original_task = result.scalar_one_or_none\\(\\)\n        original_description = original_task.description\n        original_completed = original_task.completed\n    \n    # Update title\n    async with AsyncClient\\(app=app, base_url=\"http://test\"\\) as client:\n        response = await client.post\\(\n            f\"/api/{verified_user_with_tasks.id}/chat\",\n            json={\"message\": \"Change task 1 title to 'Buy groceries and snacks'\"},\n            headers={\"Authorization\": f\"Bearer {auth_token}\"}\n        \\)\n\n    assert response.status_code == 200\n    \n    # Verify other fields unchanged\n    async with get_session\\(\\) as session:\n        result = await session.execute\\(\n            select\\(TodoTask\\).where\\(\n                TodoTask.user_id == verified_user_with_tasks.id,\n                TodoTask.title.contains\\(\"snacks\"\\)\n            \\)\n        \\)\n        updated_task = result.scalar_one_or_none\\(\\)\n        assert updated_task.description == original_description\n        assert updated_task.completed == original_completed\nEOF)"
    ]
  }
}
